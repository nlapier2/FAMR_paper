# Real data analysis scripts for the FAMR paper

This folder contains scripts used to preprocess real data, run MR methods on it,
and generate results used in the FAMR paper.


### Downloading the data

First, we preprocessed the data. The input was generally expected to be
VCF files in the MRC IEU GWAS format, 
[described here](https://github.com/MRCIEU/gwas-vcf-specification), 
for each exposure and factor.

As described in the FAMR paper, we downloaded data from the
[IEU Open GWAS Portal](https://gwas.mrcieu.ac.uk/datasets/)
and the [OMICSPRED Website](https://www.omicspred.org/),
the latter for data from the INTERVAL consortium.
Please see the paper for the exact trait IDs downloaded.
The INTERVAL Nightingale data used in the paper was in a TSV format that had to
be preprocessed into the MRC IEU GWAS format, which we did with `tsv2vcf.R`.

For some of the functionality of preprocessing and results scripts, such as
replacing raw trait names with human-readable ones or taking a subset of the
exposures, a "trait names" file is required, which is a simple TSV mapping
the raw trait names to the human-readable versions.
Examples that we used are included in the `trait_names` folder.
Please see the paper for the exact trait IDs used.


### Preprocessing the data

Preprocessing many exposure VCFs by breaking them into independent loci,
merging the loci, and then combining data across all traits was in some cases
quite computationally expensive to run serially for many exposures.
Thus, we developed a pipeline for our compute cluster that performed steps in
parallel where possible. This is broken into the following scripts:

* `get_regions_vcf.R`: This picks loci around peak SNPs for each trait 
separately. It only needs to be re-run if you want to change the size of the 
loci or the maximum peak p-value required to create a locus. 
Should take about 10-15 mins per trait (parallelized).
* `merge_regions_vcf.R`: This merges the per-trait regions over all or a list 
of traits. This is needed for multivariable MR analysis, but is skipped in 
univariate MR analysis. Should take less than one minute.
* `extract_loci_vcf.R`: This extracts summary statistics corresponding to each 
of the loci above from the full summary statistics for each trait of interest. 
Should take 10-15 mins per trait (parallelized).
* `merge_loci_vcf.R`: This merges the loci for individual traits into loci over 
all traits of interest. Should take about 15-20 mins per locus (parallelized).

The `submit/` directory contains the compute jobs used to run all of these
scripts and thus provides sample usages of each script.

Next, we generated linkage disequilibrium matrices for each of these regions
using the UK Biobank unrelated White British samples. We include a script in
`submit/` that we used to do this, but since the data is not public-access, we
cannot share the raw data.


### Running the methods

FAMR is run by the [FAMR package](https://github.com/nlapier2/FAMR/).
MR-BMA code is in the `mr-bma.R` script, and code for all other methods is
in the `methods.R` script. `run_methods.R` is a wrapper script to run a list of
these methods, adding factors as extra exposures if specified by the user.
`utils.R` is a utility script that contains common functions used by many of 
those scripts.

`real_data_analysis_vcf.R` is a wrapper script to run methods other than
FAMR-Susie on the data and compiles their results into a single RDS file.

`univar_real_data_analysis_vcf.R` is a script used to run univariate IVW MR.
It performs instrument selection independently for the given exposure, so it
largely does not make use of the preprocessing pipeline above, and instead
directly takes a VCF as input.

The `submit/` directory contains the compute jobs used to run all of these
scripts and thus provides sample usages of each script.

Finally, `summarize_real_data_results.R` is a helpful script to summarize the
probability of causality for each exposure-outcome pair generated by each
method as a single TSV file. From this file, the results in the FAMR paper's
tables can be easily extracted.
